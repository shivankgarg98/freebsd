## **audit(4) support to NFS: idea and design document**



1. **Where should the audit hooks be added to  efficiently audit the NFS RPC from server?**

I chose to add `AUDIT_NFSRPC_ENTER` and `AUDIT_NFSRPC_EXIT` macros in `nfs_proc()` function defined in `sys/fs/nfsserver/nfs_nfsdkrpc.c` The reason being it call the the `nfsrvd_dorpc` whenever their is some request. These macros are useful to for event preselection(TBD) and allocating/committing the new record.

When the thread will be servicing the RPC, the desirable RPC arguments can audited using the AUDIT_ARG_* macros.

2. **What all information has to be audited and recorded in log files?**

- Each RPC has to be audited and various desired argument in it should be audited. 

- To clarify above point: The client(subject) information, the NFS RPC request made by it and files etc, it accessed or modified.

- This all information that would have appeared in client's audit record if it'd be audit(4) runs on client.

  | NFSv3 RPC Service | Arguments | Status |
  | ----------------- | --------- | ------ |
  | nfsrvd_getattr    |           |        |
  | nfsrvd_setattr    |           |        |
  | nfsrvd_lookup     |           |        |
  |                   |           |        |
  |                   |           |        |

3. **How would the audit(4) would be interpret the NFS records and show it ?**

The `praudit`has to be modified accordingly to able to interpret the new addition and show the record to user for analysis. (and able to distinguish them as NFS remote event by client and are not generated by local user)

4. **Do we need to define new audit event type, audit token for this new support? or Use currently defined?**

Not Sure.









#### Doubts while deploying the above design-

1. The audit record info is maintained by the thread structure. The thread may already be maintaining the audit records from the syscalls. I doubt when using this from NFS, it may interfare with syscall audit and show unexpected behaviour. For instance, failing of `KASSERT(td->td_ar == NULL, ("audit_syscall_enter: td->td_ar != NULL"))` if it is called in the `audit_nfsrpc_enter`.
2. how to use AUDIT_ARG_TEXT wrapper to record text?



